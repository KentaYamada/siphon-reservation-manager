rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuth() {
        return true;
    }

    function hasId(id) {
        return id != null;
    }

    function validationBusinessDaySchema(businessDay) {
        return businessDay.size() == 3
            && ("business_date" in businessDay)
            && ("published_datetime" in businessDay)
            && ("is_pause" in businessDay)
            && (businessDay.business_date is timestamp)
            && (businessDay.published_datetime == null
                || (businessDay.business_date != null && businessDay.published_datetime is timestamp))
            && (businessDay.is_pause is bool);
    }

    function validationSelectableTimezoneSchema(timezone) {
        return timezone.size() == 3
            && ("start_time" in timezone)
            && ("end_time" in timezone)
            && ("selected" in timezone)
            && (timezone.start_time is timestamp)
            && (timezone.end_time is timestamp)
            && (timezone.selected is bool);
    }

    // [GET] /business_days/{document}
    match /business_days/{document} {
      allow list: if isAuth();

      // [GET] /business_days/{document}/timezones/{document}
      match /timezones/{document} {
        allow list: if isAuth();
      }
    }

    // [GET] /business_days/{businessDayId}
    match /business_days/{businessDayId} {
      allow get: if isAuth() && hasId(businessDayId);

      // [GET] /business_days/{businessDayId}/timezones/{timezoneId}
      match /timezones/{timezoneId} {
        allow get: if isAuth() && hasId(timezoneId);
      }
    }

    // [POST] /business_days/{document}
    match /business_days/{document} {
      allow create: if isAuth()
                    && validationBusinessDaySchema(request.resource.data);

      // [POST] /business_days/{document}/timezones/{document}
      match /timezones/{document} {
        allow create: if isAuth()
                      && validationSelectableTimezoneSchema(request.resource.data);
      }
    }

    // [PUT] /business_days/{businessDayId}
    match /business_days/{businessDayId} {
      allow update: if isAuth()
                    && hasId(businessDayId)
                    && validationBusinessDaySchema(request.resource.data);

      // [PUT] /business_days/{businessDayId}/timezones/{timezoneId}
      match /timezones/{document} {
        allow create: if isAuth()
                      && validationSelectableTimezoneSchema(request.resource.data);
      }
      match /timezones/{timezoneId} {
        allow update: if isAuth()
                      && hasId(timezoneId)
                      && validationSelectableTimezoneSchema(request.resource.data);
      }
    }

    // [DELETE] /business_days/{businessDayId}
    match /business_days/{businessDayId} {
      allow delete: if isAuth() && hasId(businessDayId);

      // [DELETE] /business_days/{businessDayId}/timezones/{timezoneId}
      match /timezones/{timezoneId} {
        allow delete: if isAuth() && hasId(timezoneId);
      }
    }

    match /reservations/{document} {
        allow list: if isAuth();
    }

    match /reservations/{document} {
        allow create, delete: if true;
    }

    match /reservations/{reservationId} {
      allow get: if hasId(reservationId);
    }

    match /reservations/{reservationId} {
        allow update, delete: if hasId(reservationId);
    }

    match /reservation_resend_mails/{document} {
        allow create: if true;
    }

    match /reservation_seats/{document} {
        allow list, create, delete: if true;
    }

    match /reservation_seats/{id} {
        allow update: if true;
    }

    // [GET] /timezones/{document}
    match /timezones/{document} {
        allow list: if isAuth();
    }

    // [GET] /timezones/{timezoneId}
    match /timezones/{timezoneId} {
        allow get: if isAuth() && hasId(timezoneId);
    }

    // [POST] /timezones/{document}
    match /timezones/{document} {
        allow create: if isAuth();
    }

    // [PUT] /timezones/{timezoneId}
    match /timezones/{timezoneId} {
        allow update: if isAuth() && hasId(timezoneId);
    }

    // [DELETE] /timezones/{timezoneId}
    match /timezones/{timezoneId} {
        allow delete: if isAuth() && hasId(timezoneId);
    }
  }
}
